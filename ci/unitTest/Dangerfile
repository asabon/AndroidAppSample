# ===== ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ =====
# JUnit XML ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦å¤±æ•—ã‚’è¡¨ç¤º
Dir.glob("app/build/test-results/**/*.xml").each do |path|
    junit.parse path
end

# ãƒ†ã‚¹ãƒˆçµæœã‚’ PR ã‚³ãƒ¡ãƒ³ãƒˆã«è¡¨ç¤º
junit.report

if junit.failures.length == 0
    message("âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¯ã™ã¹ã¦æˆåŠŸã—ã¾ã—ãŸã€‚")
else
    warn("âŒ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã«å¤±æ•—ãŒã‚ã‚Šã¾ã™ã€‚")
end

# ===== ã‚«ãƒãƒ¬ãƒƒã‚¸ =====
# Kover XML ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ coverage ã‚’è¡¨ç¤º
require 'nokogiri'

begin
  kover_path = 'app/build/reports/kover/report.xml'
  if File.exist?(kover_path)
    xml = File.read(kover_path)
    doc = Nokogiri::XML(xml)
    counter = doc.at_xpath('//counter[@type="INSTRUCTION"]')

    if counter
      covered = counter['covered'].to_i
      missed = counter['missed'].to_i
      total = covered + missed
      coverage = total > 0 ? (covered * 100.0 / total).round(2) : 0.0

      markdown("ğŸ§ª **Test Coverage:** #{coverage}% (INSTRUCTION)")
    else
      warn("âš ï¸ Kover XML ã« INSTRUCTION ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
    end
  else
    warn("âš ï¸ Kover XML ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
  end
rescue => e
  warn("âš ï¸ Kover coverage ã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: #{e.message}")
end

# ===== ãƒ•ã‚¡ã‚¤ãƒ«å˜ä½ã®ã‚«ãƒãƒ¬ãƒƒã‚¸è¡¨ç¤º =====
begin
  changed_files = git.modified_files + git.added_files
  coverage_details = []

  # ===== ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ main ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¨å®š =====
  test_files = changed_files.select { |f| f.include?("/test/") && f.end_with?("Test.kt") }
  inferred_main_files = test_files.map do |test_path|
    test_name = File.basename(test_path)
    main_name = test_name.sub("Test", "")
    test_path.sub("src/test", "src/main").sub(test_name, main_name)
  end

  # ===== coverage å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµ±åˆ =====
  target_files = (changed_files + inferred_main_files).uniq

  # ===== coverage XML ã‹ã‚‰å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã® coverage ã‚’æŠ½å‡º =====
  doc.xpath('//class').each do |klass|
    class_name = klass['name']
    package_name = klass.parent['name']
    file_path = "app/src/main/java/#{package_name.gsub('.', '/')}/#{class_name}.kt"

    next unless target_files.include?(file_path)

    counter = klass.xpath('./counter[@type="INSTRUCTION"]').first
    next unless counter

    covered = counter['covered'].to_i
    missed = counter['missed'].to_i
    total = covered + missed
    coverage = total > 0 ? (covered * 100.0 / total).round(2) : 0.0

    coverage_details << "| `#{file_path}` | #{coverage}% |"
  end

  if coverage_details.any?
    markdown("### ğŸ§ª Coverage by Modified File\n\n| File | Coverage |\n|------|----------|\n" + coverage_details.join("\n"))
  else
    message("â„¹ï¸ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œã™ã‚‹ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
  end
rescue => e
  warn("âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«å˜ä½ã®ã‚«ãƒãƒ¬ãƒƒã‚¸è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼: #{e.message}")
end
